# Домашнее задание к занятию "`Troubleshooting`" - `Живарев Игорь`


### Задание 1

Перед выполнением задания ознакомьтесь с документацией по администрированию MongoDB.

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её нужно прервать.

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.


Ответ:

```
1. Необходимо найти opid операции:

db.currentOp({ "active" : true, "secs_running" : { "$gt" : 180 }})

{
    "inprog" : [
        {
            //...
            "opid" : 12345,
            "secs_running" : NumberLong(123)
            //...
        }
    ]
}

2. Завершить принудительно

db.killOp(12345)
```

1. Использовать метод maxTimeMS() для установки предела исполнения по времени операций.
2. Используя Database Profiler, отловить медленные операции. С помощью executionStats проанализировать. Попробовать
оптимизировать: добавить/удалить индексы, настроить шардинг и т.д.

---

### Задание 2

Перед выполнением задания познакомьтесь с документацией по Redis latency troobleshooting.

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и увеличивается пропорционально количеству реплик сервиса.

При масштабировании сервиса до N реплик вы увидели, что:

сначала происходит рост отношения записанных значений к истекшим,
Redis блокирует операции записи.
Как вы думаете, в чём может быть проблема?


Ответ:

Если в базе данных много ключей, срок действия которых истекает в одну секунду, и они составляют не менее 25% от текущей совокупности ключей с истекающим сроком, Redis может применить блокировки, чтобы получить процент уже истекших ключей ниже 25%.

Таким образом, большое количество ключей, истекающиих в один и тот же момент, может быть источником задержки.

---

### Задание 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы пользователи начали жаловаться на ошибки вида:

```
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?


Ответ:

1. Возможно, запрос затронул огромное число строк, так что его выполнение оборвалось по таймауту.
2. Увеличить значение системной переменной net_read_timeout.
Возможно, шардирование и использование индексов поможет ускорить работу запросов.

### Задание 4

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили эту проблему?


Ответ:

Причина в нехватке памяти. При возникновении нехватки памяти oom-killer убивает самый ресурсоёмкий процесс чтобы не допустить kernel panic. ООМ каждому процессу выставляет оценку (oom_score) и на основании этой оценки выбирает следующий процесс для удаления.
Для предотвращения такой ситуации можно выставить ограничения в Postgres на использование ресурсов хоста, так же можно понизить рейтинг процесса postgres, чтобы уменьшить вероятность его попадания под oom-killer.


---
